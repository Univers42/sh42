#!/bin/sh
. "$(dirname "$0")/log_hook.sh"

TYPES="feat|fix|docs|refactor|test"
ALLOWED_TYPES="feat, fix, docs, refactor, test"
FORBIDDEN="WIP|update|squash!|debug|temporary"
FORBIDDEN_WORDS="WIP, update, squash!, debug, temporary"

MSG_FILE="$1"
if [ -z "$MSG_FILE" ]; then
	exit 0
fi

# PUBLISH MODE: only enforce length >= 250 words, nothing else.
if [ "${GIT_PUBLISH:-}" = "1" ]; then
	# Skip checks for merge commits to avoid blocking automated merge messages
	if git rev-parse -q --verify MERGE_HEAD >/dev/null 2>&1; then
		log_info "publish mode: merge commit detected â€” skipping length check."
		exit 0
	fi
	# Count words excluding commented/empty lines
	word_count=$(awk '!/^[[:space:]]*($|#)/{print}' "$MSG_FILE" | wc -w | tr -d '[:space:]')
	if [ "$word_count" -lt 25 ]; then
		log_error "publish mode: commit message must contain at least 250 words (got $word_count)."
		log_info  "Tip: provide a detailed description via: MSG=\"your long message ...\""
		exit 1
	fi
	log_success "publish mode: commit message length OK ($word_count words)."
	exit 0
fi

log_broadcast "COMMIT_SYSTEM"

header=$(awk '!/^[[:space:]]*($|#)/{print;exit}' "$MSG_FILE")

if ! printf "%s" "$header" | grep -Eiq "^($TYPES)\([^)]+\):[[:space:]]*.+$"; then
	log_error "Commit header must match: type(scope): <description>"
	log_info "Expected format: type(scope): <description>"
	log_info "Allowed types: ${ALLOWED_TYPES}"
	log_example "Example: feat(core): Add support for colored logging in all git hooks"
	exit 1
fi

description=$(printf "%s" "$header" | sed -E "s/^($TYPES)\([^)]+\):[[:space:]]*(.*)$/\2/I")
len=$(printf '%s' "$description" | wc -c | tr -d '[:space:]')
if [ "$len" -lt 25 ] || [ "$len" -gt 170 ]; then
	log_error "Description length must be between 25 and 170 characters (got $len)."
	log_info "Your description: \"$description\""
	exit 1
fi

if grep -Eiq "$FORBIDDEN" "$MSG_FILE"; then
	log_error "Commit message contains forbidden word(s)."
	log_warn "Forbidden words: ${FORBIDDEN_WORDS}"
	exit 1
fi

log_success "commit-msg: Commit message passed validation."
exit 0
