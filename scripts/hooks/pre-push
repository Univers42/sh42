#!/bin/bash
. "$(dirname "$0")/log_hook.sh"

remote="$1"
url="$2"

FORBIDDEN_PATTERNS=("WIP" "update" "squash!" "debug" "temporary")
PROTECTED_BRANCHES=("main" "master" "develop")
TYPES_REGEX="^(feat|fix|docs|refactor|test)\([^)]+\):[[:space:]]*.+$"
ALLOWED_TYPES="feat, fix, docs, refactor, test"
FORBIDDEN_WORDS="WIP, update, squash!, debug, temporary"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')

log_broadcast "COMMIT_SYSTEM"

# Read lines: local_ref local_oid remote_ref remote_oid
while read local_ref local_oid remote_ref remote_oid; do
	branch="${local_ref##refs/heads/}"

	# Block direct pushes to protected branches
	for pb in "${PROTECTED_BRANCHES[@]}"; do
		if [[ "$branch" == "$pb" ]]; then
			log_error "Direct push to protected branch '$branch' blocked."
			exit 1
		fi
	done

	# Skip deletes
	if [[ "$local_oid" = "$zero" ]]; then
		continue
	fi

	# Determine commits to inspect (commits on local not present on remote)
	if [[ "$remote_oid" = "$zero" ]]; then
		commits=$(git rev-list "$local_oid")
	else
		commits=$(git rev-list "$remote_oid..$local_oid")
	fi

	for commit in $commits; do
		msg=$(git log -n1 --pretty=format:%B "$commit")
		header=$(printf "%s\n" "$msg" | awk '!/^[[:space:]]*($|#)/{print;exit}')

		# Header format
		if ! printf "%s" "$header" | grep -Eiq "$TYPES_REGEX"; then
			log_error "Commit $commit on $branch: invalid header format."
			log_info "Expected format: type(scope): <description>"
			log_info "Allowed types: ${ALLOWED_TYPES}"
			log_example "Example: feat(core): Add support for colored logging in all git hooks"
			exit 1
		fi

		# Description length
		description=$(printf "%s" "$header" | sed -E 's/^(feat|fix|docs|refactor|test)\([^)]+\):[[:space:]]*(.*)$/\2/I')
		len=$(printf '%s' "$description" | wc -c | tr -d '[:space:]')
		if [ "$len" -lt 50 ] || [ "$len" -gt 170 ]; then
			log_error "Commit $commit on $branch: description length $len must be between 50 and 170 characters."
			log_info "Your description: \"$description\""
			exit 1
		fi

		# Forbidden patterns (case-insensitive, fixed-string match)
		for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
			if printf "%s" "$msg" | grep -iqF "$pattern"; then
				log_error "Commit $commit on $branch: contains forbidden pattern '$pattern'."
				log_warn "Forbidden words: ${FORBIDDEN_WORDS}"
				exit 1
			fi
		done
	done
done

log_success "pre-push: All commits passed validation."
exit 0