#!/bin/bash
. "$(dirname "$0")/log_hook.sh"

remote="$1"
url="$2"

FORBIDDEN_PATTERNS=("WIP" "update" "squash!" "debug" "temporary")
PROTECTED_BRANCHES=("main" "master" "develop")
TYPES_REGEX="^(feat|fix|docs|refactor|test)\([^)]+\):[[:space:]]*.+$"
ALLOWED_TYPES="feat, fix, docs, refactor, test"
FORBIDDEN_WORDS="WIP, update, squash!, debug, temporary"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')

log_broadcast "PUSH SYSTEM - VALIDATION"

while read local_ref local_oid remote_ref remote_oid; do
	branch="${local_ref##refs/heads/}"

	for pb in "${PROTECTED_BRANCHES[@]}"; do
		if [[ "$branch" == "$pb" ]]; then
			log_error "Direct push to protected branch '$branch' is blocked for safety."
			log_info "Protected branches: ${PROTECTED_BRANCHES[*]}"
			log_warn "Please use a feature or topic branch and open a pull request."
			log_info "How to safely redirect your changes from '$branch' to a feature branch:"
			log_info "  1. Create a new branch from your current state:"
			log_example "     git checkout -b my-feature-branch"
			log_info "  2. Push your new branch to origin:"
			log_example "     git push origin my-feature-branch"
			log_info "  3. Open a pull request from 'my-feature-branch' to '$branch' on GitHub."
			log_info "If you already committed to '$branch', you can use:"
			log_example "     git checkout -b my-feature-branch"
			log_example "     git push origin my-feature-branch"
			log_info "Then reset '$branch' if needed:"
			log_example "     git checkout $branch"
			log_example "     git reset --hard origin/$branch"
			exit 1
		fi
	done

	if [[ "$local_oid" = "$zero" ]]; then
		continue
	fi

	if [[ "$remote_oid" = "$zero" ]]; then
		commits=$(git rev-list "$local_oid")
	else
		commits=$(git rev-list "$remote_oid..$local_oid")
	fi

	for commit in $commits; do
		msg=$(git log -n1 --pretty=format:%B "$commit")
		header=$(printf "%s\n" "$msg" | awk '!/^[[:space:]]*($|#)/{print;exit}')

		if ! printf "%s" "$header" | grep -Eiq "$TYPES_REGEX"; then
			log_error "Commit ${commit} on branch '${branch}' has an invalid header format."
			log_info "Expected format: type(scope): <description>"
			log_info "Allowed types: ${ALLOWED_TYPES}"
			log_example "Example: feat(core): Add support for colored logging in all git hooks"
			exit 1
		fi

		description=$(printf "%s" "$header" | sed -E 's/^(feat|fix|docs|refactor|test)\([^)]+\):[[:space:]]*(.*)$/\2/I')
		len=$(printf '%s' "$description" | wc -c | tr -d '[:space:]')
		if [ "$len" -lt 25 ] || [ "$len" -gt 170 ]; then
			log_error "Commit ${commit} on branch '${branch}' has a description length of $len (must be 50-170)."
			log_info "Your description: \"$description\""
			log_warn "Please provide a more detailed and concise description."
			exit 1
		fi

		for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
			if printf "%s" "$msg" | grep -iqF "$pattern"; then
				log_error "Commit ${commit} on branch '${branch}' contains forbidden pattern: '$pattern'."
				log_warn "Forbidden words: ${FORBIDDEN_WORDS}"
				log_info "Please revise your commit message to remove forbidden words."
				exit 1
			fi
		done
	done
done

log_success "All commits passed validation. Push allowed."
exit 0