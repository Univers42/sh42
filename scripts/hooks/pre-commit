#!/bin/sh
. "$(dirname "$0")/log_hook.sh"

TYPES="feat|fix|docs|refactor|test"
ALLOWED_TYPES="feat, fix, docs, refactor, test"
FORBIDDEN="WIP|update|squash!|debug|temporary"
FORBIDDEN_WORDS="WIP, update, squash!, debug, temporary"

MSG_FILE="$1"
if [ -z "$MSG_FILE" ]; then
	exit 0
fi

log_broadcast "COMMIT_SYSTEM"

header=$(awk '!/^[[:space:]]*($|#)/{print;exit}' "$MSG_FILE")

if ! printf "%s" "$header" | grep -Eiq "^($TYPES)\([^)]+\):[[:space:]]*.+$"; then
	log_error "Commit header must match: type(scope): <description>"
	log_info "Expected format: type(scope): <description>"
	log_info "Allowed types: ${ALLOWED_TYPES}"
	log_example "Example: feat(core): Add support for colored logging in all git hooks"
	exit 1
fi

description=$(printf "%s" "$header" | sed -E "s/^($TYPES)\([^)]+\):[[:space:]]*(.*)$/\2/I")
len=$(printf '%s' "$description" | wc -c | tr -d '[:space:]')
if [ "$len" -lt 25 ] || [ "$len" -gt 170 ]; then
	log_error "Description length must be between 50 and 170 characters (got $len)."
	log_info "Your description: \"$description\""
	exit 1
fi

if grep -Eiq "$FORBIDDEN" "$MSG_FILE"; then
	log_error "Commit message contains forbidden word(s)."
	log_warn "Forbidden words: ${FORBIDDEN_WORDS}"
	exit 1
fi

log_success "pre-commit: Commit message passed validation."
exit 0
