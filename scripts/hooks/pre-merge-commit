#!/bin/sh
. "$(dirname "$0")/log_hook.sh"

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT" || exit 0

branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")"
if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
	exit 0
fi

# If no upstream configured, nothing to pull
if ! git rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1; then
	log_debug "No upstream for '$branch' â€” skipping pre-merge pull."
	exit 0
fi

upstream="$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null)"
log_info "Pre-merge: attempting fast-forward pull from '$upstream' for branch '$branch'..."

if git pull --ff-only >/dev/null 2>&1; then
	log_success "Pre-merge auto-pull succeeded for '$branch'."
	exit 0
fi

# pull failed â€” ask user whether to continue (use /dev/tty)
log_warn "Pre-merge auto-pull failed for '$branch' (non-fast-forward or network issue)."

# Non-interactive auto-allow (CI) via env var
if [ "${GIT_CONFIRM_PUSH:-}" = "yes" ] || [ "${GIT_CONFIRM_PUSH:-}" = "1" ]; then
	log_warn "GIT_CONFIRM_PUSH=yes detected; proceeding with merge despite failed pull."
	exit 0
fi

if [ -r /dev/tty ]; then
	printf "Pre-merge pull failed. Do you want to proceed with the merge anyway? [y/N]: " > /dev/tty
	read -r answer < /dev/tty || answer=""
	case "$answer" in
		y|Y|yes|YES|Yes)
			log_info "User chose to proceed with merge despite failed pre-merge pull."
			exit 0
			;;
		*)
			log_error "Merge aborted: please fetch/pull and resolve upstream changes first."
			exit 1
			;;
	esac
else
	log_error "Non-interactive environment and no override; aborting merge. Run 'git pull' and try again."
	exit 1
fi
