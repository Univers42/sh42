#!/bin/sh
. "$(dirname "$0")/log_hook.sh"

# args: previous HEAD, new HEAD, is_branch_checkout (1 when branch was checked out)
prev_ref="$1"
new_ref="$2"
is_branch="$3"

# Respect opt-out
if [ "${GIT_AUTO_PULL:-yes}" = "no" ]; then
	log_info "Auto-pull disabled (GIT_AUTO_PULL=no)."
	exit 0
fi

# only act on branch checkouts
if [ "$is_branch" != "1" ]; then
	exit 0
fi

# ensure we are at repo top
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT" || exit 0

branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")"
if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
	exit 0
fi

# check upstream
if git rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1; then
	upstream="$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null)"
	log_info "Auto-pull: attempting fast-forward pull from '$upstream' for branch '$branch'..."
	if git pull --ff-only >/dev/null 2>&1; then
		log_success "Auto-pull succeeded for '$branch'."
	else
		log_warn "Auto-pull failed for '$branch' (non-fast-forward or network error)."
		log_info "Please run: git pull to resolve or rebase as appropriate."
	fi
else
	log_debug "No upstream configured for branch '$branch'; skipping auto-pull."
fi

exit 0
